import { createState, createComputed, createEffect } from "solid-js";

const LOCAL_STORAGE_KEY = "todos-solid";

function createLocalState(value) {
  // load stored todos on init
  const stored = localStorage.getItem(LOCAL_STORAGE_KEY),
    [state, setState] = createState(stored ? JSON.parse(stored) : value);

  // JSON.stringify creates deps on every iterable field
  createEffect(() => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state)));
  return [state, setState];
}

export default function createTodosStore() {
  const [state, setState] = createLocalState({
    counter: 1,
    todos: [],
    showMode: "all"
  });
  createComputed(() => {
    const completedCount = state.todos.filter(todo => todo.completed).length;
    setState({
      completedCount,
      remainingCount: state.todos.length - completedCount
    });
  });

  return [state, {
      addTodo: ({ title }) => setState({
        todos: [{ title, id: state.counter, completed: false }, ...state.todos],
        counter: state.counter + 1
      }),
      removeTodo: todoId => setState("todos", t => t.filter(item => item.id !== todoId)),
      editTodo: todo => setState("todos", state.todos.findIndex(item => item.id === todo.id), todo),
      clearCompleted: () => setState("todos", t => t.filter(todo => !todo.completed)),
      toggleAll: completed => setState("todos", todo => todo.completed !== completed, { completed }),
      setVisibility: showMode => setState("showMode", showMode)
    }
  ];
}
